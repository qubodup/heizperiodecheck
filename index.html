<!DOCTYPE html> 
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Heizperiode Temperaturcheck 21 Uhr</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    textarea { width: 100%; height: 200px; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
    .day-highlight { background: yellow; font-weight: bold; }
    .temp-low { background: orange; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Heizperiode Temperaturcheck 21 Uhr</h2>
  <p>1. <a href="https://www.dwd.de/DE/leistungen/klimadatendeutschland/klarchivstunden.html">DWD-Daten</a> herunterladen, 2. Inhalt der produkt_tu_stunde_....txt-Datei einfügen.</p>
  <textarea id="input"></textarea><br>
  <button onclick="processData()">Verarbeiten</button>

  <h3>Aktuellste 5 Werte um 21 Uhr</h3>
  <table id="last5"></table>

  <h3>Seit dem letzten Wert ≥ 12 °C um 21 Uhr</h3>
  <table id="sinceLast12"></table>

  <h3>Tägliche Werte um 21 Uhr</h3>
  <table id="output"></table>

  <script>
    const months = [
      "Januar","Februar","März","April","Mai","Juni",
      "Juli","August","September","Oktober","November","Dezember"
    ];

    function formatGermanDate(datetime) {
      // datetime = YYYYMMDDhh
      const yyyy = parseInt(datetime.substring(0,4));
      const MM = parseInt(datetime.substring(4,6),10);
      const dd = parseInt(datetime.substring(6,8),10);
      const hh = datetime.substring(8,10);
      return `${dd}. ${months[MM-1]} ${yyyy}, ${hh}:00`;
    }

    function processData() {
      const raw = document.getElementById("input").value.trim().split("\n");
      const rows = raw.map(line => line.split(";").map(x => x.trim()));

      // === filter all rows with hour=21 ===
      const rows21 = rows.filter(r => {
        const datetime = r[1] || "";
        return datetime.length === 10 && datetime.substring(8,10) === "21";
      });

      // sort ascending by datetime numeric (so earliest first)
      rows21.sort((a,b) => Number(a[1]) - Number(b[1]));

      // === Last 5 values at 21h (descending) ===
      const last5Rows = [...rows21].sort((a,b)=>Number(b[1])-Number(a[1])).slice(0,5);
      const last5Table = document.getElementById("last5");
      last5Table.innerHTML = `
        <tr>
          <th>Zeit</th>
          <th>Temperatur</th>
        </tr>
      `;
      last5Rows.forEach(r => {
        const dateFormatted = formatGermanDate(r[1]);
        const temp = parseFloat(r[3]);
        const tempHTML = temp < 12 
          ? `<span class="temp-low">${temp} °C</span>` 
          : `${temp} °C`;
        last5Table.innerHTML += `
          <tr>
            <td>${dateFormatted}</td>
            <td>${tempHTML}</td>
          </tr>
        `;
      });

      // === Since last ≥12°C at 21h ===
      // find the last entry (by date) with temp>=12
      const idx = [...rows21].reverse().findIndex(r => parseFloat(r[3])>=12);
      let sinceRows = [];
      if (idx !== -1) {
        // index from end; convert to forward index:
        const forwardIndex = rows21.length - 1 - idx;
        sinceRows = rows21.slice(forwardIndex);
				// newest first:
				sinceRows.sort((a,b)=>Number(b[1]) - Number(a[1]));
      }
      const sinceTable = document.getElementById("sinceLast12");
      sinceTable.innerHTML = `
        <tr>
          <th>Zeit</th>
          <th>Temperatur</th>
        </tr>
      `;
      sinceRows.forEach(r => {
        const dateFormatted = formatGermanDate(r[1]);
        const temp = parseFloat(r[3]);
        const tempHTML = temp < 12 
          ? `<span class="temp-low">${temp} °C</span>` 
          : `${temp} °C`;
        sinceTable.innerHTML += `
          <tr>
            <td>${dateFormatted}</td>
            <td>${tempHTML}</td>
          </tr>
        `;
      });

      // === 21:00 daily first values ===
      const seenDays = new Set();
      const filtered = [];
      for (const r of rows) {
        const datetime = r[1];
        if (datetime.length !== 10) continue;
        const date = datetime.substring(0, 8); // YYYYMMDD
        const hour = datetime.substring(8, 10);
        if (hour === "21" && !seenDays.has(date)) {
          seenDays.add(date);
          filtered.push(r);
        }
      }

			// sort newest first:
			filtered.sort((a,b)=>Number(b[1]) - Number(a[1]));

      // Build table
      const out = document.getElementById("output");
      out.innerHTML = "";
      if (filtered.length === 0) {
        out.innerHTML = "<tr><td>Keine 21:00-Einträge gefunden</td></tr>";
        return;
      }

      // Header
      out.innerHTML = `
        <tr>
          <th>Zeit</th>
          <th>Temperatur</th>
        </tr>
      `;

      filtered.forEach(r => {
        const dateFormatted = formatGermanDate(r[1]);
        const temp = parseFloat(r[3]);
        const tempHTML = temp < 12 
          ? `<span class="temp-low">${temp} °C</span>` 
          : `${temp} °C`;

        out.innerHTML += `
          <tr>
            <td>${dateFormatted}</td>
            <td>${tempHTML}</td>
          </tr>
        `;
      });
    }
  </script>
</body>
</html>
